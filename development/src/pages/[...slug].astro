---
import "@/lib/global.css";
import site from "@/content/site.json";
import { PortfolioApp } from "@/lib/components/PortfolioApp";
import { getCollection } from "astro:content";
import { renderMarkdown } from "@/lib/markdown";

export async function getStaticPaths() {
    const allSections = await getCollection("sections", ({ data }) => {
        return import.meta.env.PROD ? data.published : true;
    });

    const sortedSections = allSections.sort((a, b) => a.data.order - b.data.order);

    // Create paths for each section
    const paths = sortedSections.map((section) => ({
        params: { slug: section.slug },
        props: { initialSectionId: section.slug },
    }));

    // Also include the root path (index) which defaults to the first section
    paths.push({
        params: { slug: undefined },
        props: { initialSectionId: sortedSections[0]?.slug || "" },
    });

    return paths;
}

const { initialSectionId } = Astro.props;

// Fetch all sections to pass to the client-side app
const allSections = await getCollection("sections", ({ data }) => {
    return import.meta.env.PROD ? data.published : true;
});

const sortedSections = allSections.sort((a, b) => a.data.order - b.data.order);

const sections = sortedSections.map((section) => ({
    id: section.slug,
    title: section.data.title,
    description: section.data.description,
    html: renderMarkdown(section.body),
}));

const currentSection = sections.find((s) => s.id === initialSectionId);
const title = currentSection?.title || site.title;
const description = currentSection?.description || site.description;
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />

        <title>{title}</title>
        <meta name="title" content={title} />
        <meta name="description" content={description} />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={Astro.url} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={Astro.url} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content={description} />
    </head>
    <body class="bg-background text-foreground antialiased overflow-hidden">
        <PortfolioApp
            client:load
            sections={sections}
            initialSectionId={initialSectionId}
        />
    </body>
</html>
